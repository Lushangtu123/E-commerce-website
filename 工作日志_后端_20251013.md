# 后端开发工作日志 - 2025年10月13日

## 📋 概述

本次工作主要解决后端 API 的数据库字段映射问题和添加商品功能的实现。

---

## 🐛 问题 1: 数据库字段映射错误

### 问题现象
- 管理员获取商品列表返回 500 错误
- 用户列表查询失败

### 错误日志
```
Error: Unknown column 'c.category_name' in 'field list'
Error: Unknown column 'u.status' in 'field list'
```

### 问题原因

通过检查数据库表结构发现字段不匹配：

```bash
# 查看 categories 表
mysql> DESCRIBE categories;
+-------------+--------------+------+-----+-------------------+
| Field       | Type         | Null | Key | Default           |
+-------------+--------------+------+-----+-------------------+
| category_id | int          | NO   | PRI | NULL              |
| name        | varchar(100) | NO   |     | NULL              |
| parent_id   | int          | YES  | MUL | NULL              |
| sort_order  | int          | YES  |     | 0                 |
+-------------+--------------+------+-----+-------------------+

# 查看 users 表（没有 status 字段）
mysql> DESCRIBE users;
+---------------+---------------+------+-----+-------------------+
| Field         | Type          | Null | Key | Default           |
+---------------+---------------+------+-----+-------------------+
| user_id       | bigint        | NO   | PRI | NULL              |
| username      | varchar(50)   | NO   | UNI | NULL              |
| email         | varchar(100)  | NO   | UNI | NULL              |
| password_hash | varchar(255)  | NO   |     | NULL              |
| phone         | varchar(20)   | YES  |     | NULL              |
| avatar_url    | varchar(255)  | YES  |     | NULL              |
| created_at    | timestamp     | YES  |     | CURRENT_TIMESTAMP |
| updated_at    | timestamp     | YES  |     | CURRENT_TIMESTAMP |
+---------------+---------------+------+-----+-------------------+
```

### 解决方案

#### 1. 修复商品管理控制器

**文件**: `backend/src/controllers/admin-product.controller.ts`

**修改位置**: 第 31-42 行

```typescript
// ❌ 修改前
const [products] = await pool.query(
  `SELECT 
    p.*,
    c.category_name,
    (SELECT COUNT(*) FROM order_items oi WHERE oi.product_id = p.product_id) as total_sales
   FROM products p
   LEFT JOIN categories c ON p.category_id = c.category_id
   WHERE ${whereClause}
   ORDER BY p.created_at DESC
   LIMIT ? OFFSET ?`,
  [...params, limit, offset]
);

// ✅ 修改后
const [products] = await pool.query(
  `SELECT 
    p.*,
    c.name as category_name,
    (SELECT COUNT(*) FROM order_items oi WHERE oi.product_id = p.product_id) as total_sales
   FROM products p
   LEFT JOIN categories c ON p.category_id = c.category_id
   WHERE ${whereClause}
   ORDER BY p.created_at DESC
   LIMIT ? OFFSET ?`,
  [...params, limit, offset]
);
```

#### 2. 修复用户管理控制器

**文件**: `backend/src/controllers/admin-user.controller.ts`

**修改 1**: 移除 status 字段查询（第 18-33 行）

```typescript
// ❌ 修改前
if (keyword) {
  whereClause += ' AND (u.username LIKE ? OR u.email LIKE ? OR u.phone LIKE ?)';
  params.push(`%${keyword}%`, `%${keyword}%`, `%${keyword}%`);
}
if (status !== undefined) {
  whereClause += ' AND u.status = ?';
  params.push(status);
}

const [users] = await pool.query(
  `SELECT 
    u.user_id,
    u.username,
    u.email,
    u.phone,
    u.status,
    u.created_at,
    ...

// ✅ 修改后
if (keyword) {
  whereClause += ' AND (u.username LIKE ? OR u.email LIKE ? OR u.phone LIKE ?)';
  params.push(`%${keyword}%`, `%${keyword}%`, `%${keyword}%`);
}

const [users] = await pool.query(
  `SELECT 
    u.user_id,
    u.username,
    u.email,
    u.phone,
    u.created_at,
    ...
```

**修改 2**: 用户详情查询（第 74-86 行）

```typescript
// 移除了 u.status 字段
const [users] = await pool.query(
  `SELECT 
    u.user_id,
    u.username,
    u.email,
    u.phone,
    u.created_at,
    u.updated_at,
    (SELECT COUNT(*) FROM orders o WHERE o.user_id = u.user_id) as order_count,
    (SELECT COALESCE(SUM(total_amount), 0) FROM orders o WHERE o.user_id = u.user_id AND o.status IN (1,2,3,4)) as total_spent
   FROM users u
   WHERE u.user_id = ?`,
  [userId]
);
```

**修改 3**: 禁用用户状态更新功能（第 126-129 行）

```typescript
export const updateUserStatus = async (req: Request, res: Response) => {
  try {
    // 由于users表没有status字段，此功能暂时不可用
    res.status(501).json({ error: '用户状态功能暂未实现，需要先在数据库中添加status字段' });
  } catch (error) {
    console.error('更新用户状态失败:', error);
    res.status(500).json({ error: '更新失败' });
  }
};
```

**修改 4**: 简化用户统计（第 136-140 行）

```typescript
// ❌ 修改前
const [userStats] = await pool.query(
  `SELECT 
    COUNT(*) as total_users,
    SUM(CASE WHEN status = 1 THEN 1 ELSE 0 END) as active_users,
    SUM(CASE WHEN status = 0 THEN 1 ELSE 0 END) as inactive_users
   FROM users`
);

// ✅ 修改后
const [userStats] = await pool.query(
  `SELECT 
    COUNT(*) as total_users
   FROM users`
);
```

### 部署步骤

```bash
# 1. 编译 TypeScript
cd backend
npm run build

# 2. 重新构建 Docker 镜像
cd ..
docker-compose build backend

# 3. 重启后端容器
docker-compose up -d backend

# 4. 查看日志确认启动成功
docker-compose logs --tail=20 backend
```

### 验证结果

```bash
# 测试商品列表 API
curl -s -H "Authorization: Bearer {token}" \
  http://localhost:3001/api/admin/products | head -c 200

# 输出：
# {"products":[{"product_id":1,"title":"iPhone 15 Pro Max","category_name":"电子产品",...

✅ 商品列表 API 正常返回，包含 category_name 字段
✅ 用户列表 API 正常返回（无 status 字段）
```

---

## 🐛 问题 2: 添加商品功能实现

### 问题现象
- 前端调用添加商品 API 返回 500 错误
- 错误日志：`Unknown column 'image_url' in 'field list'`

### 问题原因

数据库 `products` 表中的图片字段是 `main_image`，而不是 `image_url`：

```bash
mysql> DESCRIBE products;
+------------+--------------+------+-----+-------------------+
| Field      | Type         | Null | Key | Default           |
+------------+--------------+------+-----+-------------------+
| main_image | varchar(255) | YES  |     | NULL              |
| images     | json         | YES  |     | NULL              |
+------------+--------------+------+-----+-------------------+
```

### 解决方案

#### 1. 修复创建商品函数

**文件**: `backend/src/controllers/admin-product.controller.ts`

**修改位置**: 第 152-176 行

```typescript
// ❌ 修改前
export const createProduct = async (req: Request, res: Response) => {
  try {
    const pool = getPool();
    const {
      title,
      description,
      price,
      stock,
      category_id,
      image_url,
      status = 1
    } = req.body;

    if (!title || !price || !category_id) {
      return res.status(400).json({ error: '标题、价格和分类不能为空' });
    }

    const [result] = await pool.query(
      `INSERT INTO products 
       (title, description, price, stock, category_id, image_url, status, created_at, updated_at)
       VALUES (?, ?, ?, ?, ?, ?, ?, NOW(), NOW())`,
      [title, description, price, stock || 0, category_id, image_url, status]
    );
    ...
  }
};

// ✅ 修改后
export const createProduct = async (req: Request, res: Response) => {
  try {
    const pool = getPool();
    const {
      title,
      description,
      price,
      stock,
      category_id,
      brand,           // 新增
      image_url,
      status = 1
    } = req.body;

    if (!title || !price || !category_id) {
      return res.status(400).json({ error: '标题、价格和分类不能为空' });
    }

    const [result] = await pool.query(
      `INSERT INTO products 
       (title, description, price, stock, category_id, brand, main_image, status, created_at, updated_at)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, NOW(), NOW())`,
      [title, description, price, stock || 0, category_id, brand, image_url, status]
    );
    
    const productId = (result as any).insertId;

    // 记录操作日志
    await logAdminAction(
      (req as any).admin.adminId,
      'CREATE_PRODUCT',
      'product',
      productId.toString(),
      `创建商品: ${title}`,
      req.ip,
      req.get('user-agent')
    );

    res.status(201).json({
      message: '创建成功',
      product_id: productId
    });
  } catch (error) {
    console.error('创建商品失败:', error);
    res.status(500).json({ error: '创建失败' });
  }
};
```

#### 2. 修复更新商品函数

**文件**: `backend/src/controllers/admin-product.controller.ts`

**修改位置**: 第 249-252 行

```typescript
// ❌ 修改前
if (image_url !== undefined) {
  updates.push('image_url = ?');
  values.push(image_url);
}

// ✅ 修改后
if (image_url !== undefined) {
  updates.push('main_image = ?');
  values.push(image_url);
}
```

#### 3. 添加获取分类列表 API

**文件**: `backend/src/controllers/product.controller.ts`

**新增函数**（第 132-147 行）：

```typescript
// 获取分类列表
static async getCategories(req: Request, res: Response) {
  try {
    const { getPool } = require('../database/mysql');
    const pool = getPool();
    
    const [categories] = await pool.query(
      'SELECT category_id, name, parent_id, sort_order FROM categories ORDER BY sort_order ASC, category_id ASC'
    );
    
    res.json(categories);
  } catch (error) {
    console.error('获取分类列表失败:', error);
    res.status(500).json({ error: '获取分类列表失败' });
  }
}
```

#### 4. 添加路由

**文件**: `backend/src/routes/product.routes.ts`

```typescript
import { Router } from 'express';
import { ProductController } from '../controllers/product.controller';

const router = Router();

// ⚠️ 注意：特殊路由必须放在动态路由 /:id 之前
// 获取分类列表（必须在 /:id 之前）
router.get('/categories', ProductController.getCategories);

// 获取热门商品（必须在 /:id 之前）
router.get('/hot', ProductController.getHotProducts);

// 获取商品列表
router.get('/', ProductController.list);

// 获取商品详情（动态路由放在最后）
router.get('/:id', ProductController.getDetail);

// 创建商品（管理员）
router.post('/', ProductController.create);

// 更新商品（管理员）
router.put('/:id', ProductController.update);

export default router;
```

### 部署步骤

```bash
# 1. 编译代码
cd backend
npm run build

# 2. 重新构建镜像
cd ..
docker-compose build backend

# 3. 重启容器
docker-compose up -d backend

# 4. 验证
sleep 5
docker-compose logs --tail=10 backend
```

### API 测试

```bash
# 1. 获取管理员 Token
TOKEN=$(curl -s -X POST http://localhost:3001/api/admin/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}' \
  | grep -o '"token":"[^"]*' | cut -d'"' -f4)

# 2. 测试获取分类列表
curl -s http://localhost:3001/api/products/categories

# 输出：
# [
#   {"category_id":1,"name":"电子产品","parent_id":null,"sort_order":1},
#   {"category_id":2,"name":"服装鞋包","parent_id":null,"sort_order":2},
#   ...
# ]

# 3. 测试添加商品
curl -X POST http://localhost:3001/api/admin/products \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "测试商品",
    "description": "这是一个测试商品",
    "price": 99.99,
    "stock": 100,
    "category_id": 1,
    "brand": "测试品牌",
    "image_url": "https://placehold.co/400x400",
    "status": 1
  }'

# 输出：
# {"message":"创建成功","product_id":13}
```

### 验证结果

```bash
# 查看数据库
docker-compose exec mysql mysql -uroot -proot123456 ecommerce \
  -e "SELECT product_id, title, price, brand, main_image FROM products WHERE product_id = 13;"

# 输出：
# +------------+--------------+--------+--------------+---------------------------+
# | product_id | title        | price  | brand        | main_image                |
# +------------+--------------+--------+--------------+---------------------------+
# |         13 | 测试商品     |  99.99 | 测试品牌     | https://placehold.co/400  |
# +------------+--------------+--------+--------------+---------------------------+

✅ 商品成功添加到数据库
✅ 字段映射正确（image_url -> main_image）
✅ brand 字段正常保存
```

---

## 📊 数据库字段映射总结

### products 表
| 前端/API 字段 | 后端接收字段 | 数据库字段 | 说明 |
|-------------|------------|----------|------|
| image_url | image_url | main_image | 主图片 URL |
| - | - | images | JSON 格式的多图片 |
| brand | brand | brand | 品牌名称 |

### categories 表
| 代码中使用 | 数据库字段 | 获取方式 |
|----------|----------|---------|
| category_name | name | JOIN 或 AS 别名 |

### users 表
| 功能需求 | 数据库字段 | 状态 |
|---------|----------|------|
| 用户状态管理 | status | ❌ 未实现（字段不存在） |

---

## 💡 最佳实践总结

### 1. 数据库字段命名一致性

**问题**：代码中使用的字段名与数据库不一致，导致 SQL 错误。

**解决方案**：
- 开发前先查看数据库表结构：`DESCRIBE table_name`
- 使用 SQL 别名进行字段映射：`c.name AS category_name`
- 建立字段映射文档

### 2. SQL 查询最佳实践

```typescript
// ✅ 推荐：使用别名
SELECT 
  p.*,
  c.name as category_name,  // 使用 AS 别名
  u.username as user_name
FROM products p
LEFT JOIN categories c ON p.category_id = c.category_id

// ❌ 避免：假设字段名
SELECT 
  p.*,
  c.category_name,  // 假设字段存在
  u.user_name
FROM products p
```

### 3. API 参数与数据库字段映射

```typescript
// 前端提交的字段名可以与数据库不同
// 在后端进行映射

// 接收前端参数
const { image_url, brand } = req.body;

// 映射到数据库字段
await pool.query(
  'INSERT INTO products (main_image, brand) VALUES (?, ?)',
  [image_url, brand]  // 参数映射
);
```

### 4. 路由顺序很重要

```typescript
// ✅ 正确顺序
router.get('/categories', handler);  // 具体路径在前
router.get('/hot', handler);
router.get('/:id', handler);         // 动态路由在后

// ❌ 错误顺序
router.get('/:id', handler);         // 会匹配 /categories
router.get('/categories', handler);  // 永远不会执行
```

---

## 🔧 开发工具和命令

### 查看数据库表结构
```bash
# 进入 MySQL 容器
docker-compose exec mysql mysql -uroot -proot123456 ecommerce

# 查看表结构
DESCRIBE products;
DESCRIBE categories;
DESCRIBE users;

# 查看所有表
SHOW TABLES;

# 退出
exit;
```

### 后端日志查看
```bash
# 实时查看
docker-compose logs -f backend

# 查看最近 50 行
docker-compose logs --tail=50 backend

# 查看错误日志
docker-compose logs backend | grep -i error
```

### 快速重启流程
```bash
# 完整重启流程
cd backend && npm run build && cd ..
docker-compose build backend
docker-compose up -d backend
docker-compose logs --tail=20 backend
```

---

## 📌 遗留问题

### 用户状态管理功能

**状态**: 暂未实现

**原因**: 数据库 `users` 表中没有 `status` 字段

**影响范围**:
- 管理后台无法禁用/启用用户
- 用户统计中无法区分活跃/禁用用户

**解决方案**（可选）:

如果需要实现此功能：

```sql
-- 1. 添加数据库字段
ALTER TABLE users 
ADD COLUMN status TINYINT DEFAULT 1 
COMMENT '用户状态: 1-正常, 0-禁用';

-- 2. 为现有用户设置默认值
UPDATE users SET status = 1 WHERE status IS NULL;
```

然后恢复 `backend/src/controllers/admin-user.controller.ts` 中被注释的代码。

---

## ✅ 完成清单

- [x] 修复商品列表 category_name 字段错误
- [x] 修复用户列表 status 字段错误
- [x] 实现添加商品 API
- [x] 修复商品图片字段映射（image_url -> main_image）
- [x] 添加获取分类列表 API
- [x] 优化路由顺序
- [x] 编译和部署代码
- [x] API 测试验证
- [ ] 用户状态管理功能（可选）

---

**工作日期**: 2025年10月13日  
**后端服务状态**: ✅ 运行正常  
**API 可用性**: ✅ 所有接口正常  
**数据库连接**: ✅ 健康  


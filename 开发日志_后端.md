# åç«¯å¼€å‘å·¥ä½œæ—¥å¿—

> è®°å½•æ‰€æœ‰åç«¯ç›¸å…³çš„å¼€å‘ã€é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

---

## ğŸ“… 2025å¹´10æœˆ13æ—¥ - æ•°æ®åº“å­—æ®µæ˜ å°„é—®é¢˜ä¿®å¤

### ğŸ› é—®é¢˜1: æ•°æ®åº“å­—æ®µæ˜ å°„é”™è¯¯

**é—®é¢˜ç°è±¡ï¼š**
- ç®¡ç†å‘˜è·å–å•†å“åˆ—è¡¨è¿”å› 500 é”™è¯¯
- ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢å¤±è´¥

**é”™è¯¯æ—¥å¿—ï¼š**
```
Error: Unknown column 'c.category_name' in 'field list'
Error: Unknown column 'u.status' in 'field list'
Error: Unknown column 'oi.order_item_id' in 'field list'
```

**é—®é¢˜åŸå› ï¼š**

æ•°æ®åº“å®é™…å­—æ®µä¸ä»£ç ä¸­ä½¿ç”¨çš„å­—æ®µåä¸åŒ¹é…ï¼š

```bash
# categories è¡¨å®é™…å­—æ®µ
mysql> DESCRIBE categories;
+-------------+--------------+
| Field       | Type         |
+-------------+--------------+
| category_id | int          |
| name        | varchar(100) |  â† ä¸æ˜¯ category_name
| parent_id   | int          |
| sort_order  | int          |
+-------------+--------------+

# users è¡¨ï¼ˆæ²¡æœ‰ status å­—æ®µï¼‰
mysql> DESCRIBE users;
+---------------+---------------+
| Field         | Type          |
+---------------+---------------+
| user_id       | bigint        |
| username      | varchar(50)   |
| email         | varchar(100)  |
| password_hash | varchar(255)  |
| phone         | varchar(20)   |
| avatar_url    | varchar(255)  |
| created_at    | timestamp     |
| updated_at    | timestamp     |
+---------------+---------------+
# æ³¨æ„ï¼šæ²¡æœ‰ status å­—æ®µ

# order_items è¡¨
+---------------+---------------+
| item_id       | bigint        |  â† ä¸æ˜¯ order_item_id
| order_id      | bigint        |
| product_id    | bigint        |
+---------------+---------------+
```

**è§£å†³æ–¹æ¡ˆï¼š**

**ä¿®å¤1ï¼šå•†å“ç®¡ç†æ§åˆ¶å™¨**

**æ–‡ä»¶ï¼š** `backend/src/controllers/admin-product.controller.ts`

```typescript
// âŒ ä¿®æ”¹å‰
const [products] = await pool.query(
  `SELECT 
    p.*,
    c.category_name,  // å­—æ®µä¸å­˜åœ¨
    (SELECT COUNT(*) FROM order_items oi 
     WHERE oi.product_id = p.product_id) as total_sales
   FROM products p
   LEFT JOIN categories c ON p.category_id = c.category_id
   ...`
);

// âœ… ä¿®æ”¹å - ä½¿ç”¨åˆ«å
const [products] = await pool.query(
  `SELECT 
    p.*,
    c.name as category_name,  // ä½¿ç”¨ AS åˆ«å
    (SELECT COUNT(*) FROM order_items oi 
     WHERE oi.product_id = p.product_id) as total_sales
   FROM products p
   LEFT JOIN categories c ON p.category_id = c.category_id
   ...`
);
```

**ä¿®å¤2ï¼šç”¨æˆ·ç®¡ç†æ§åˆ¶å™¨**

**æ–‡ä»¶ï¼š** `backend/src/controllers/admin-user.controller.ts`

```typescript
// âŒ ä¿®æ”¹å‰
const [users] = await pool.query(
  `SELECT 
    u.user_id,
    u.username,
    u.email,
    u.phone,
    u.status,  // å­—æ®µä¸å­˜åœ¨
    u.created_at,
    ...`
);

// âœ… ä¿®æ”¹å - ç§»é™¤ä¸å­˜åœ¨çš„å­—æ®µ
const [users] = await pool.query(
  `SELECT 
    u.user_id,
    u.username,
    u.email,
    u.phone,
    u.created_at,
    ...`
);

// åŒæ—¶ç§»é™¤ status ç›¸å…³çš„ WHERE æ¡ä»¶
// âŒ if (status !== undefined) { whereClause += ' AND u.status = ?'; }
```

**ä¿®å¤3ï¼šç®¡ç†å‘˜ä»ªè¡¨ç›˜æ§åˆ¶å™¨**

**æ–‡ä»¶ï¼š** `backend/src/controllers/admin.controller.ts`

```typescript
// ä¿®å¤ order_items å­—æ®µå
// âŒ oi.order_item_id â†’ âœ… oi.item_id

// ä¿®å¤ products å›¾ç‰‡å­—æ®µ
// âŒ p.image_url â†’ âœ… p.main_image
```

---

### ğŸ› é—®é¢˜2: æ·»åŠ å•†å“åŠŸèƒ½å­—æ®µé”™è¯¯

**é—®é¢˜ç°è±¡ï¼š**
- å‰ç«¯è°ƒç”¨æ·»åŠ å•†å“ API è¿”å› 500 é”™è¯¯
- é”™è¯¯æ—¥å¿—ï¼š`Unknown column 'image_url' in 'field list'`

**é—®é¢˜åŸå› ï¼š**
- products è¡¨çš„å›¾ç‰‡å­—æ®µæ˜¯ `main_image`
- ä½†ä»£ç ä½¿ç”¨äº† `image_url`

**æ•°æ®åº“è¡¨ç»“æ„ï¼š**
```sql
CREATE TABLE products (
  product_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  title VARCHAR(200) NOT NULL,
  description TEXT,
  category_id INT,
  brand VARCHAR(100),
  price DECIMAL(10,2) NOT NULL,
  original_price DECIMAL(10,2),
  stock INT DEFAULT 0,
  main_image VARCHAR(255),  â† æ­£ç¡®å­—æ®µå
  images JSON,
  ...
);
```

**è§£å†³æ–¹æ¡ˆï¼š**

**æ–‡ä»¶ï¼š** `backend/src/controllers/admin-product.controller.ts`

```typescript
// createProduct å‡½æ•°
export const createProduct = async (req: Request, res: Response) => {
  const {
    title,
    description,
    price,
    stock,
    category_id,
    brand,
    image_url,  // å‰ç«¯ä¼ å…¥çš„å‚æ•°å
    status = 1
  } = req.body;

  // âŒ ä¿®æ”¹å‰
  const [result] = await pool.query(
    `INSERT INTO products 
     (title, description, price, stock, category_id, brand, image_url, status, ...)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ...)`,
    [title, description, price, stock || 0, category_id, brand, image_url, status]
  );

  // âœ… ä¿®æ”¹å - æ˜ å°„åˆ°æ­£ç¡®çš„å­—æ®µå
  const [result] = await pool.query(
    `INSERT INTO products 
     (title, description, price, stock, category_id, brand, main_image, status, ...)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ...)`,
    [title, description, price, stock || 0, category_id, brand, image_url, status]
  );
};

// updateProduct å‡½æ•°åŒæ ·ä¿®å¤
if (image_url !== undefined) {
  updates.push('main_image = ?');  // ä½¿ç”¨æ­£ç¡®çš„å­—æ®µå
  values.push(image_url);
}
```

---

### âœ¨ æ–°å¢åŠŸèƒ½ï¼šè·å–åˆ†ç±»åˆ—è¡¨ API

**èƒŒæ™¯ï¼š**
å‰ç«¯æ·»åŠ å•†å“æ—¶éœ€è¦åˆ†ç±»åˆ—è¡¨ï¼Œä½†æ²¡æœ‰å¯¹åº”çš„å…¬å¼€APIã€‚

**å®ç°ï¼š**

**æ–‡ä»¶ï¼š** `backend/src/controllers/product.controller.ts`

```typescript
// è·å–åˆ†ç±»åˆ—è¡¨
static async getCategories(req: Request, res: Response) {
  try {
    const { getPool } = require('../database/mysql');
    const pool = getPool();
    
    const [categories] = await pool.query(
      `SELECT category_id, name, parent_id, sort_order 
       FROM categories 
       ORDER BY sort_order ASC, category_id ASC`
    );
    
    res.json(categories);
  } catch (error) {
    console.error('è·å–åˆ†ç±»åˆ—è¡¨å¤±è´¥:', error);
    res.status(500).json({ error: 'è·å–åˆ†ç±»åˆ—è¡¨å¤±è´¥' });
  }
}
```

**è·¯ç”±é…ç½®ï¼š**

**æ–‡ä»¶ï¼š** `backend/src/routes/product.routes.ts`

```typescript
// âš ï¸ é‡è¦ï¼šè·¯ç”±é¡ºåºå¾ˆå…³é”®ï¼
// ç‰¹æ®Šè·¯ç”±å¿…é¡»æ”¾åœ¨åŠ¨æ€è·¯ç”± /:id ä¹‹å‰

router.get('/categories', ProductController.getCategories);  // âœ… åœ¨å‰
router.get('/hot', ProductController.getHotProducts);        // âœ… åœ¨å‰
router.get('/', ProductController.list);
router.get('/:id', ProductController.getDetail);             // âœ… åœ¨å

// âŒ é”™è¯¯ç¤ºä¾‹
router.get('/:id', ...);          // ä¼šåŒ¹é… /categories
router.get('/categories', ...);   // æ°¸è¿œä¸ä¼šæ‰§è¡Œ
```

---

## ğŸ“… 2025å¹´10æœˆ29æ—¥ - æ”¶è—å’ŒSKUåŠŸèƒ½å®ç°

### âœ¨ æ–°åŠŸèƒ½1ï¼šæ”¶è—ç³»ç»Ÿ

#### æ•°æ®åº“è®¾è®¡

**æ–°è¡¨ï¼š** `favorites`

```sql
CREATE TABLE favorites (
  favorite_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  product_id BIGINT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uk_user_product (user_id, product_id),
  INDEX idx_user (user_id),
  INDEX idx_product (product_id)
) ENGINE=InnoDB;
```

**è®¾è®¡è¦ç‚¹ï¼š**
- å”¯ä¸€çº¦æŸé˜²æ­¢é‡å¤æ”¶è—
- ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- ç®€å•é«˜æ•ˆçš„è¡¨ç»“æ„

#### åç«¯å®ç°

**1. æ•°æ®æ¨¡å‹**

**æ–‡ä»¶ï¼š** `backend/src/models/favorite.model.ts`ï¼ˆ140è¡Œï¼‰

```typescript
export class FavoriteModel {
  // æ·»åŠ æ”¶è—
  static async add(userId: number, productId: number): Promise<number>
  
  // å–æ¶ˆæ”¶è—
  static async remove(userId: number, productId: number): Promise<boolean>
  
  // æ£€æŸ¥æ˜¯å¦å·²æ”¶è—
  static async isFavorited(userId: number, productId: number): Promise<boolean>
  
  // è·å–ç”¨æˆ·æ”¶è—åˆ—è¡¨ï¼ˆå¸¦åˆ†é¡µï¼‰
  static async getUserFavorites(userId: number, page: number, limit: number)
  
  // æ‰¹é‡æ£€æŸ¥æ”¶è—çŠ¶æ€
  static async checkMultipleFavorites(userId: number, productIds: number[])
  
  // è·å–æ”¶è—æ•°é‡
  static async getFavoriteCount(userId: number): Promise<number>
  
  // è·å–å•†å“è¢«æ”¶è—æ¬¡æ•°
  static async getProductFavoriteCount(productId: number): Promise<number>
}
```

**å…³é”®å®ç°ï¼š**

```typescript
// æ·»åŠ æ”¶è— - å¤„ç†é‡å¤
static async add(userId: number, productId: number): Promise<number> {
  try {
    const result = await query<ResultSetHeader>(
      'INSERT INTO favorites (user_id, product_id) VALUES (?, ?)',
      [userId, productId]
    );
    return result.insertId;
  } catch (error: any) {
    // å¦‚æœæ˜¯é‡å¤é”®é”™è¯¯ï¼Œè¿”å›0
    if (error.code === 'ER_DUP_ENTRY') {
      return 0;
    }
    throw error;
  }
}

// è·å–æ”¶è—åˆ—è¡¨ - è”è¡¨æŸ¥è¯¢
static async getUserFavorites(userId: number, page: number, limit: number) {
  const offset = (page - 1) * limit;
  
  const favorites = await query(
    `SELECT 
      f.favorite_id,
      f.user_id,
      f.product_id,
      f.created_at,
      p.title,
      p.price,
      p.original_price,
      p.main_image,
      p.stock,
      p.status
    FROM favorites f
    LEFT JOIN products p ON f.product_id = p.product_id
    WHERE f.user_id = ?
    ORDER BY f.created_at DESC
    LIMIT ? OFFSET ?`,
    [userId, limit, offset]
  );
  
  // è·å–æ€»æ•°
  const [countResult] = await query(
    'SELECT COUNT(*) as total FROM favorites WHERE user_id = ?',
    [userId]
  );
  
  return { favorites, total: countResult.total };
}
```

**2. æ§åˆ¶å™¨**

**æ–‡ä»¶ï¼š** `backend/src/controllers/favorite.controller.ts`ï¼ˆ155è¡Œï¼‰

```typescript
import { Response } from 'express';
import { FavoriteModel } from '../models/favorite.model';
import { AuthRequest } from '../middleware/auth';

// æ·»åŠ æ”¶è—
export const addFavorite = async (req: AuthRequest, res: Response) => {
  const userId = req.user?.userId;
  const { product_id } = req.body;
  
  if (!product_id) {
    return res.status(400).json({ message: 'å•†å“IDä¸èƒ½ä¸ºç©º' });
  }
  
  const favoriteId = await FavoriteModel.add(userId, product_id);
  
  if (favoriteId === 0) {
    return res.status(200).json({ 
      message: 'è¯¥å•†å“å·²åœ¨æ”¶è—å¤¹ä¸­',
      already_favorited: true 
    });
  }
  
  res.json({ message: 'æ”¶è—æˆåŠŸ', favorite_id: favoriteId });
};

// åˆ‡æ¢æ”¶è—çŠ¶æ€ï¼ˆæ™ºèƒ½ï¼‰
export const toggleFavorite = async (req: AuthRequest, res: Response) => {
  const userId = req.user?.userId;
  const { product_id } = req.body;
  
  const isFavorited = await FavoriteModel.isFavorited(userId, product_id);
  
  if (isFavorited) {
    await FavoriteModel.remove(userId, product_id);
    return res.json({ 
      message: 'å–æ¶ˆæ”¶è—æˆåŠŸ',
      is_favorited: false 
    });
  } else {
    const favoriteId = await FavoriteModel.add(userId, product_id);
    return res.json({ 
      message: 'æ”¶è—æˆåŠŸ',
      is_favorited: true,
      favorite_id: favoriteId 
    });
  }
};
```

**3. è·¯ç”±é…ç½®**

**æ–‡ä»¶ï¼š** `backend/src/routes/favorite.routes.ts`ï¼ˆ30è¡Œï¼‰

```typescript
import express from 'express';
import { authMiddleware } from '../middleware/auth';
import {
  addFavorite,
  removeFavorite,
  toggleFavorite,
  checkFavorite,
  getUserFavorites,
  checkMultipleFavorites,
  getFavoriteCount
} from '../controllers/favorite.controller';

const router = express.Router();

// æ‰€æœ‰æ”¶è—è·¯ç”±éƒ½éœ€è¦è®¤è¯
router.use(authMiddleware);

router.post('/', addFavorite);
router.delete('/:product_id', removeFavorite);
router.post('/toggle', toggleFavorite);
router.get('/check/:product_id', checkFavorite);
router.post('/check-multiple', checkMultipleFavorites);
router.get('/my', getUserFavorites);
router.get('/count', getFavoriteCount);

export default router;
```

**4. ä¸»åº”ç”¨æ³¨å†Œè·¯ç”±**

**æ–‡ä»¶ï¼š** `backend/src/index.ts`

```typescript
import favoriteRoutes from './routes/favorite.routes';

// APIè·¯ç”±
app.use('/api/favorites', favoriteRoutes);
```

**APIæ¥å£åˆ—è¡¨ï¼š**
- `POST /api/favorites` - æ·»åŠ æ”¶è—
- `DELETE /api/favorites/:product_id` - å–æ¶ˆæ”¶è—
- `POST /api/favorites/toggle` - åˆ‡æ¢æ”¶è—çŠ¶æ€
- `GET /api/favorites/check/:product_id` - æ£€æŸ¥å•ä¸ªå•†å“
- `POST /api/favorites/check-multiple` - æ‰¹é‡æ£€æŸ¥
- `GET /api/favorites/my` - è·å–æ”¶è—åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
- `GET /api/favorites/count` - è·å–æ”¶è—æ•°é‡

---

### âœ¨ æ–°åŠŸèƒ½2ï¼šå•†å“SKUç³»ç»Ÿ

#### æ•°æ®åº“è®¾è®¡

**æ–°è¡¨ï¼š** `product_skus`

```sql
CREATE TABLE product_skus (
  sku_id BIGINT PRIMARY KEY AUTO_INCREMENT,
  product_id BIGINT NOT NULL,
  sku_code VARCHAR(50) UNIQUE NOT NULL,
  specs JSON COMMENT 'SKUè§„æ ¼ {"é¢œè‰²":"çº¢è‰²","å°ºå¯¸":"M"}',
  price DECIMAL(10,2) NOT NULL,
  original_price DECIMAL(10,2),
  stock INT DEFAULT 0,
  image VARCHAR(255),
  status TINYINT DEFAULT 1 COMMENT '1:å¯ç”¨ 0:ç¦ç”¨',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_product (product_id),
  INDEX idx_sku_code (sku_code),
  INDEX idx_status (status)
) ENGINE=InnoDB;
```

**è®¾è®¡ç‰¹ç‚¹ï¼š**
- SKUç¼–ç å”¯ä¸€æ€§çº¦æŸ
- JSONæ ¼å¼å­˜å‚¨çµæ´»è§„æ ¼
- ç‹¬ç«‹çš„ä»·æ ¼å’Œåº“å­˜
- æ”¯æŒSKUçº§åˆ«çš„å¯ç”¨/ç¦ç”¨

#### åç«¯å®ç°

**1. SKUæ•°æ®æ¨¡å‹**

**æ–‡ä»¶ï¼š** `backend/src/models/sku.model.ts`ï¼ˆ225è¡Œï¼‰

```typescript
export class SKUModel {
  // åŸºç¡€CRUD
  static async create(data: SKUData): Promise<number>
  static async createBatch(skus: SKUData[]): Promise<void>
  static async findById(skuId: number): Promise<ProductSKU | null>
  static async findBySKUCode(skuCode: string): Promise<ProductSKU | null>
  static async findByProductId(productId: number): Promise<ProductSKU[]>
  static async update(skuId: number, data: Partial<ProductSKU>): Promise<boolean>
  static async delete(skuId: number): Promise<boolean>
  static async deleteByProductId(productId: number): Promise<boolean>
  
  // åº“å­˜ç®¡ç†
  static async updateStock(skuId: number, quantity: number): Promise<boolean>
  static async decreaseStock(skuId: number, quantity: number): Promise<boolean>
  
  // å·¥å…·æ–¹æ³•
  static async getLowestPriceSKU(productId: number): Promise<ProductSKU | null>
  static async getTotalStock(productId: number): Promise<number>
}
```

**å…³é”®å®ç°ï¼š**

```typescript
// æ‰¹é‡åˆ›å»º SKU
static async createBatch(skus: any[]): Promise<void> {
  if (skus.length === 0) return;
  
  const values = skus.map(sku => [
    sku.product_id,
    sku.sku_code,
    JSON.stringify(sku.specs),  // JSONåºåˆ—åŒ–
    sku.price,
    sku.original_price || null,
    sku.stock,
    sku.image || null
  ]);
  
  const placeholders = skus.map(() => '(?, ?, ?, ?, ?, ?, ?)').join(', ');
  const flatValues = values.flat();
  
  await query(
    `INSERT INTO product_skus 
     (product_id, sku_code, specs, price, original_price, stock, image)
     VALUES ${placeholders}`,
    flatValues
  );
}

// JSONå¤„ç† - è¯»å–æ—¶ååºåˆ—åŒ–
static async findByProductId(productId: number): Promise<ProductSKU[]> {
  const results = await query(
    'SELECT * FROM product_skus WHERE product_id = ? AND status = 1',
    [productId]
  );
  
  // å°†JSONå­—ç¬¦ä¸²è½¬æ¢ä¸ºå¯¹è±¡
  return results.map(sku => ({
    ...sku,
    specs: typeof sku.specs === 'string' 
      ? JSON.parse(sku.specs) 
      : sku.specs
  }));
}

// åº“å­˜æ‰£å‡ï¼ˆå¸¦å¹¶å‘æ§åˆ¶ï¼‰
static async decreaseStock(skuId: number, quantity: number): Promise<boolean> {
  const result = await query(
    'UPDATE product_skus SET stock = stock - ? WHERE sku_id = ? AND stock >= ?',
    [quantity, skuId, quantity]
  );
  return result.affectedRows > 0;  // åº“å­˜ä¸è¶³æ—¶è¿”å›false
}
```

**2. å•†å“æ§åˆ¶å™¨å¢å¼º**

**æ–‡ä»¶ï¼š** `backend/src/controllers/product.controller.ts`

```typescript
// å•†å“è¯¦æƒ…è‡ªåŠ¨åŒ…å«SKUä¿¡æ¯
static async getDetail(req: Request, res: Response) {
  const productId = parseInt(req.params.id);
  
  // è·å–å•†å“åŸºæœ¬ä¿¡æ¯
  const product = await ProductModel.findById(productId);
  
  if (!product) {
    return res.status(404).json({ error: 'å•†å“ä¸å­˜åœ¨' });
  }
  
  // è·å–SKUä¿¡æ¯
  const skus = await SKUModel.findByProductId(productId);
  
  const productWithSKU = {
    ...product,
    skus: skus.length > 0 ? skus : undefined,
    has_sku: skus.length > 0
  };
  
  // ç¼“å­˜5åˆ†é’Ÿ
  await redis.setex(cacheKey, 300, JSON.stringify(productWithSKU));
  
  res.json({ product: productWithSKU });
}
```

**3. ç®¡ç†åå°SKUç®¡ç†**

**æ–‡ä»¶ï¼š** `backend/src/controllers/admin-product.controller.ts`ï¼ˆæ–°å¢170è¡Œï¼‰

```typescript
// è·å–å•†å“çš„æ‰€æœ‰SKU
export const getProductSKUs = async (req: Request, res: Response) => {
  const { productId } = req.params;
  const skus = await SKUModel.findByProductId(parseInt(productId));
  res.json({ skus });
};

// åˆ›å»ºSKU
export const createSKU = async (req: Request, res: Response) => {
  const { productId } = req.params;
  const { sku_code, specs, price, original_price, stock, image } = req.body;
  
  const skuId = await SKUModel.create({
    product_id: parseInt(productId),
    sku_code,
    specs,
    price,
    original_price,
    stock: stock || 0,
    image
  });
  
  // è®°å½•æ“ä½œæ—¥å¿—
  await logAdminAction(...);
  
  res.status(201).json({ message: 'SKUåˆ›å»ºæˆåŠŸ', sku_id: skuId });
};

// æ‰¹é‡åˆ›å»ºSKU
export const batchCreateSKUs = async (req: Request, res: Response) => {
  const { productId } = req.params;
  const { skus } = req.body;
  
  const skusWithProductId = skus.map(sku => ({
    ...sku,
    product_id: parseInt(productId)
  }));
  
  await SKUModel.createBatch(skusWithProductId);
  
  res.status(201).json({ 
    message: `æˆåŠŸåˆ›å»º${skus.length}ä¸ªSKU`,
    count: skus.length 
  });
};

// æ›´æ–°SKU
export const updateSKU = async (req: Request, res: Response)

// åˆ é™¤SKU
export const deleteSKU = async (req: Request, res: Response)
```

**4. SKUç®¡ç†è·¯ç”±**

**æ–‡ä»¶ï¼š** `backend/src/routes/admin-product.routes.ts`

```typescript
import { 
  getProductSKUs,
  createSKU,
  batchCreateSKUs,
  updateSKU,
  deleteSKU
} from '../controllers/admin-product.controller';

// SKU ç®¡ç†è·¯ç”±
router.get('/:productId/skus', requirePermission('product:view'), getProductSKUs);
router.post('/:productId/skus', requirePermission('product:create'), createSKU);
router.post('/:productId/skus/batch', requirePermission('product:create'), batchCreateSKUs);
router.put('/skus/:skuId', requirePermission('product:edit'), updateSKU);
router.delete('/skus/:skuId', requirePermission('product:delete'), deleteSKU);
```

---

## ğŸ› é—®é¢˜è§£å†³æ–¹æ¡ˆæ±‡æ€»

### é—®é¢˜1: ç¯å¢ƒé…ç½® - ç¼ºå°‘.envæ–‡ä»¶

**é”™è¯¯ï¼š**
```
Error: Access denied for user 'root'@'192.168.65.1' (using password: NO)
```

**è§£å†³ï¼š**
åˆ›å»º `backend/.env` æ–‡ä»¶ï¼š
```env
NODE_ENV=development
PORT=3001
DB_HOST=localhost
DB_PORT=3306
DB_USER=root
DB_PASSWORD=root123456
DB_NAME=ecommerce
REDIS_HOST=localhost
REDIS_PORT=6379
MONGODB_URI=mongodb://admin:admin123@localhost:27017/ecommerce?authSource=admin
JWT_SECRET=your_development_jwt_secret_key
JWT_EXPIRES_IN=7d
```

---

### é—®é¢˜2: TypeScriptç±»å‹é”™è¯¯

**é”™è¯¯ï¼š**
```
error TS2339: Property 'user' does not exist on type 'Request'
```

**åŸå› ï¼š**
ä½¿ç”¨äº† Express çš„æ™®é€š `Request` ç±»å‹ï¼Œä½†è®¿é—®äº†è‡ªå®šä¹‰çš„ `user` å±æ€§ã€‚

**è§£å†³ï¼š**
```typescript
// âŒ é”™è¯¯å†™æ³•
import { Request, Response } from 'express';
export const handler = async (req: Request, res: Response) => {
  const userId = req.user?.userId;  // ç±»å‹é”™è¯¯
};

// âœ… æ­£ç¡®å†™æ³•
import { Response } from 'express';
import { AuthRequest } from '../middleware/auth';
export const handler = async (req: AuthRequest, res: Response) => {
  const userId = req.user?.userId;  // ç±»å‹æ­£ç¡®
};
```

**AuthRequest å®šä¹‰ï¼š**
```typescript
// middleware/auth.ts
export interface AuthRequest extends Request {
  userId?: number;
  user?: any;
}

export function authMiddleware(
  req: AuthRequest, 
  res: Response, 
  next: NextFunction
) {
  const token = req.headers.authorization?.replace('Bearer ', '');
  if (!token) {
    return res.status(401).json({ error: 'æœªç™»å½•' });
  }
  
  const decoded = jwt.verify(token, process.env.JWT_SECRET!) as any;
  req.userId = decoded.userId;
  req.user = decoded;
  next();
}
```

**æœ€ä½³å®è·µï¼š**
- æ‰€æœ‰ä½¿ç”¨è®¤è¯çš„æ§åˆ¶å™¨ç»Ÿä¸€ä½¿ç”¨ `AuthRequest`
- åœ¨ middleware ä¸­å®šä¹‰æ‰©å±•çš„ Request ç±»å‹
- å¯¼å‡ºç±»å‹ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨

---

### é—®é¢˜3: Nodemonç¼“å­˜å¯¼è‡´ä»£ç ä¸æ›´æ–°

**ç°è±¡ï¼š**
- ä¿®æ”¹ä»£ç å nodemon æ˜¾ç¤ºé‡å¯
- ä½†ä»ç„¶æŠ¥æ—§çš„ç¼–è¯‘é”™è¯¯
- æ–°ä»£ç ä¸ç”Ÿæ•ˆ

**åŸå› ï¼š**
- ts-node ç¼“å­˜äº†ç¼–è¯‘ç»“æœ
- nodemon æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶çœŸæ­£å˜åŒ–

**è§£å†³æ–¹æ¡ˆï¼š**

**æ–¹æ³•1ï¼šæ¸…é™¤ç¼“å­˜**
```bash
rm -rf backend/node_modules/.cache
rm -rf backend/.ts-node
rm -rf backend/dist
```

**æ–¹æ³•2ï¼šè§¦å‘æ–‡ä»¶å˜åŒ–**
```bash
touch backend/src/controllers/favorite.controller.ts
```

**æ–¹æ³•3ï¼šå¼ºåˆ¶é‡å¯**
åœ¨ nodemon è¿è¡Œçš„ç»ˆç«¯è¾“å…¥ `rs` å¹¶æŒ‰å›è½¦

**æ–¹æ³•4ï¼šå®Œå…¨é‡å¯**
```bash
# Ctrl+C åœæ­¢
npm run dev  # é‡æ–°å¯åŠ¨
```

**æ¨èæµç¨‹ï¼š**
```bash
# å½»åº•è§£å†³
pkill -9 node                                    # åœæ­¢æ‰€æœ‰Nodeè¿›ç¨‹
rm -rf backend/node_modules/.cache backend/.ts-node  # æ¸…é™¤ç¼“å­˜
cd backend && npm run dev                        # é‡æ–°å¯åŠ¨
```

---

### é—®é¢˜4: DockeræœåŠ¡ç®¡ç†

**é”™è¯¯ï¼š**
```
Cannot connect to the Docker daemon
ECONNREFUSED 127.0.0.1:3306
```

**åŸå› ï¼š**
- Docker Desktop æœªå¯åŠ¨
- MySQL å®¹å™¨æœªè¿è¡Œ

**è§£å†³ï¼š**

**å¯åŠ¨DockeræœåŠ¡ï¼š**
```bash
# 1. ç¡®ä¿ Docker Desktop è¿è¡Œ
# 2. å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# 3. ç­‰å¾…MySQLå°±ç»ªï¼ˆçº¦30ç§’ï¼‰
sleep 30

# 4. éªŒè¯æœåŠ¡çŠ¶æ€
docker-compose ps
```

**å¼€å‘æ¨¡å¼æœ€ä½³å®è·µï¼š**
```bash
# åªè¿è¡Œæ•°æ®åº“æœåŠ¡ï¼Œåº”ç”¨æœ¬åœ°è¿è¡Œ
docker stop ecommerce-backend ecommerce-frontend

# åç«¯æœ¬åœ°è¿è¡Œï¼ˆä¾¿äºè°ƒè¯•å’Œçƒ­æ›´æ–°ï¼‰
cd backend && npm run dev

# å‰ç«¯æœ¬åœ°è¿è¡Œ
cd frontend && npm run dev
```

---

### é—®é¢˜5: ç«¯å£è¢«å ç”¨

**é”™è¯¯ï¼š**
```
Error: listen EADDRINUSE: address already in use :::3001
```

**åŸå› ï¼š**
- Docker å®¹å™¨ä¸­çš„åç«¯å ç”¨äº† 3001 ç«¯å£
- æˆ–æœ‰å…¶ä»– node è¿›ç¨‹å ç”¨

**è§£å†³ï¼š**

**æ–¹æ³•1ï¼šåœæ­¢ Docker å®¹å™¨**
```bash
docker stop ecommerce-backend
```

**æ–¹æ³•2ï¼šæŸ¥æ‰¾å¹¶æ€æ­»å ç”¨è¿›ç¨‹**
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -ti:3001

# æ€æ­»è¿›ç¨‹
lsof -ti:3001 | xargs kill -9
```

**æ–¹æ³•3ï¼šæ£€æŸ¥æ‰€æœ‰ node è¿›ç¨‹**
```bash
# æŸ¥çœ‹æ‰€æœ‰ node è¿›ç¨‹
ps aux | grep node

# å…¨éƒ¨æ¸…ç†ï¼ˆæ…ç”¨ï¼‰
pkill -9 node
```

---

### é—®é¢˜6: MySQLå®¹å™¨æœªå°±ç»ª

**ç°è±¡ï¼š**
- Docker æ˜¾ç¤º MySQL å®¹å™¨ Running
- ä½†åç«¯è¿æ¥å¤±è´¥ï¼š`ECONNREFUSED`

**åŸå› ï¼š**
- MySQL å®¹å™¨åˆšå¯åŠ¨éœ€è¦æ—¶é—´åˆå§‹åŒ–æ•°æ®åº“
- åç«¯å¯åŠ¨å¤ªæ—©ï¼ŒMySQL è¿˜æœªå‡†å¤‡å¥½æ¥å—è¿æ¥

**è§£å†³ï¼š**

**ç­‰å¾…MySQLå®Œå…¨å¯åŠ¨ï¼š**
```bash
# æ–¹æ³•1ï¼šå›ºå®šç­‰å¾…æ—¶é—´
sleep 30

# æ–¹æ³•2ï¼šå¾ªç¯æ£€æµ‹å¥åº·çŠ¶æ€ï¼ˆæ¨èï¼‰
for i in {1..30}; do
  if docker exec ecommerce-mysql mysqladmin ping -h localhost -uroot -proot123456 > /dev/null 2>&1; then
    echo "âœ… MySQLå·²å°±ç»ª"
    break
  fi
  echo "ç­‰å¾…MySQL... ($i/30)"
  sleep 1
done
```

**æ”¹è¿›å»ºè®®ï¼š**
- åœ¨å¯åŠ¨è„šæœ¬ä¸­æ·»åŠ å¥åº·æ£€æŸ¥
- åç«¯æ·»åŠ æ•°æ®åº“é‡è¿æœºåˆ¶
- ä½¿ç”¨ Docker healthcheck

---

## ğŸ’¡ åç«¯å¼€å‘æœ€ä½³å®è·µ

### 1. æ•°æ®åº“å­—æ®µä¸€è‡´æ€§

**é—®é¢˜ï¼š**ä»£ç ä¸­ä½¿ç”¨çš„å­—æ®µåä¸æ•°æ®åº“ä¸åŒ¹é…

**è§£å†³æ–¹æ¡ˆï¼š**

**å¼€å‘å‰æ£€æŸ¥ï¼š**
```bash
# æŸ¥çœ‹è¡¨ç»“æ„
mysql -e "DESCRIBE table_name;"

# æŸ¥çœ‹æ‰€æœ‰å­—æ®µ
mysql -e "SHOW COLUMNS FROM table_name;"
```

**ä½¿ç”¨åˆ«åï¼š**
```sql
-- âœ… æ¨èï¼šä½¿ç”¨ AS åˆ«å
SELECT 
  p.*,
  c.name AS category_name,
  u.username AS user_name
FROM products p
LEFT JOIN categories c ON p.category_id = c.category_id
LEFT JOIN users u ON p.user_id = u.user_id
```

**å»ºç«‹æ˜ å°„æ–‡æ¡£ï¼š**
```markdown
| APIå­—æ®µ         | æ•°æ®åº“å­—æ®µ    | è¯´æ˜        |
|----------------|-------------|------------|
| image_url      | main_image  | å•†å“ä¸»å›¾    |
| category_name  | c.name      | åˆ†ç±»åï¼ˆåˆ«åï¼‰|
```

### 2. TypeScriptç±»å‹å®‰å…¨

**å®šä¹‰æ¸…æ™°çš„æ¥å£ï¼š**

```typescript
// æ•°æ®åº“æ¨¡å‹æ¥å£
export interface Product {
  product_id: number;
  title: string;
  description?: string;
  category_id: number;
  price: number;
  stock: number;
  main_image?: string;
  status: number;
  created_at: Date;
  updated_at: Date;
}

// APIè¯·æ±‚æ¥å£
export interface CreateProductRequest {
  title: string;
  description?: string;
  price: number;
  stock?: number;
  category_id: number;
  brand?: string;
  image_url?: string;
  status?: number;
}

// APIå“åº”æ¥å£
export interface ProductListResponse {
  products: Product[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}
```

**ä½¿ç”¨ç±»å‹å®ˆå«ï¼š**

```typescript
function isProduct(obj: any): obj is Product {
  return (
    typeof obj.product_id === 'number' &&
    typeof obj.title === 'string' &&
    typeof obj.price === 'number'
  );
}

// ä½¿ç”¨
if (isProduct(data)) {
  // TypeScript çŸ¥é“ data æ˜¯ Product ç±»å‹
  console.log(data.product_id);
}
```

### 3. é”™è¯¯å¤„ç†

**ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æ¨¡å¼ï¼š**

```typescript
// æ§åˆ¶å™¨é”™è¯¯å¤„ç†
export const handler = async (req: Request, res: Response) => {
  try {
    // ä¸šåŠ¡é€»è¾‘
    const result = await someOperation();
    res.json({ success: true, data: result });
  } catch (error: any) {
    console.error('æ“ä½œå¤±è´¥:', error);
    
    // åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯
    if (error.code === 'ER_DUP_ENTRY') {
      return res.status(400).json({ error: 'æ•°æ®å·²å­˜åœ¨' });
    }
    
    if (error.code === 'ER_NO_REFERENCED_ROW_2') {
      return res.status(400).json({ error: 'å…³è”æ•°æ®ä¸å­˜åœ¨' });
    }
    
    // é€šç”¨é”™è¯¯
    res.status(500).json({ 
      error: 'æ“ä½œå¤±è´¥',
      message: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
};
```

**å…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶ï¼š**

```typescript
// index.ts
app.use((err: Error, req: Request, res: Response, next: NextFunction) => {
  console.error('é”™è¯¯:', err);
  
  res.status(500).json({ 
    error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
    message: process.env.NODE_ENV === 'development' ? err.message : undefined,
    stack: process.env.NODE_ENV === 'development' ? err.stack : undefined
  });
});
```

### 4. æ•°æ®éªŒè¯

**ä½¿ç”¨ Joi è¿›è¡Œå‚æ•°éªŒè¯ï¼š**

```typescript
import Joi from 'joi';

// å®šä¹‰éªŒè¯è§„åˆ™
const createProductSchema = Joi.object({
  title: Joi.string().required().max(200),
  description: Joi.string().optional(),
  price: Joi.number().required().positive(),
  stock: Joi.number().optional().min(0),
  category_id: Joi.number().required(),
  brand: Joi.string().optional().max(100),
  image_url: Joi.string().optional().uri(),
  status: Joi.number().optional().valid(0, 1)
});

// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨
export const createProduct = async (req: Request, res: Response) => {
  // éªŒè¯è¯·æ±‚æ•°æ®
  const { error, value } = createProductSchema.validate(req.body);
  
  if (error) {
    return res.status(400).json({ 
      error: 'å‚æ•°éªŒè¯å¤±è´¥',
      details: error.details 
    });
  }
  
  // ä½¿ç”¨éªŒè¯åçš„æ•°æ®
  const product = await ProductModel.create(value);
  res.json({ product });
};
```

### 5. æ—¥å¿—è®°å½•

**ç»“æ„åŒ–æ—¥å¿—ï¼š**

```typescript
// ä½¿ç”¨ winston æˆ–ç±»ä¼¼åº“
import winston from 'winston';

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});

// ä½¿ç”¨
logger.info('User login', { userId, email, ip: req.ip });
logger.error('Database error', { error: err.message, query });
```

### 6. APIå“åº”è§„èŒƒ

**ç»Ÿä¸€çš„å“åº”æ ¼å¼ï¼š**

```typescript
// æˆåŠŸå“åº”
{
  success: true,
  data: {...},
  message: 'æ“ä½œæˆåŠŸ'
}

// é”™è¯¯å“åº”
{
  success: false,
  error: 'é”™è¯¯ä¿¡æ¯',
  code: 'ERROR_CODE',
  details: {...}  // å¼€å‘ç¯å¢ƒ
}

// åˆ—è¡¨å“åº”
{
  success: true,
  data: [...],
  pagination: {
    page: 1,
    limit: 20,
    total: 100,
    totalPages: 5
  }
}
```

### 7. æ•°æ®åº“è¿æ¥ç®¡ç†

**ä½¿ç”¨è¿æ¥æ± ï¼š**

```typescript
import mysql from 'mysql2/promise';

const pool = mysql.createPool({
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  database: process.env.DB_NAME,
  waitForConnections: true,
  connectionLimit: 10,
  queueLimit: 0
});

// å°è£…æŸ¥è¯¢å‡½æ•°
export async function query<T>(sql: string, params?: any[]): Promise<T> {
  const [results] = await pool.execute(sql, params);
  return results as T;
}
```

---

## ğŸ“Š åç«¯æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæ¡†æ¶
- **Node.js 18** - è¿è¡Œç¯å¢ƒ
- **Express 4** - Webæ¡†æ¶
- **TypeScript 5** - ç±»å‹ç³»ç»Ÿ

### æ•°æ®åº“
- **MySQL 8.0** - ä¸»æ•°æ®åº“
- **Redis 7** - ç¼“å­˜æ•°æ®åº“
- **MongoDB 7** - æ–‡æ¡£æ•°æ®åº“

### è®¤è¯æˆæƒ
- **JWT** - Tokenè®¤è¯
- **Bcrypt** - å¯†ç åŠ å¯†

### å·¥å…·åº“
- **mysql2** - MySQLé©±åŠ¨ï¼ˆPromiseæ”¯æŒï¼‰
- **ioredis** - Rediså®¢æˆ·ç«¯
- **mongoose** - MongoDB ORM
- **joi** - æ•°æ®éªŒè¯
- **helmet** - å®‰å…¨å¤´
- **cors** - è·¨åŸŸå¤„ç†
- **compression** - å“åº”å‹ç¼©

---

## ğŸ“ å¼€å‘å·¥å…·å’Œå‘½ä»¤

### æœ¬åœ°å¼€å‘

```bash
cd backend

# å¼€å‘æ¨¡å¼ï¼ˆçƒ­é‡è½½ï¼‰
npm run dev

# ç¼–è¯‘TypeScript
npm run build

# ç”Ÿäº§æ¨¡å¼è¿è¡Œ
npm start

# æ•°æ®åº“è¿ç§»
npm run migrate:dev

# ç§å­æ•°æ®
npm run seed:dev
```

### Dockerå¼€å‘

```bash
# åªå¯åŠ¨æ•°æ®åº“æœåŠ¡
docker-compose up -d mysql redis mongodb

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f mysql
docker-compose logs -f redis

# è¿›å…¥MySQLå®¹å™¨
docker exec -it ecommerce-mysql mysql -uroot -proot123456 ecommerce

# é‡å¯æœåŠ¡
docker-compose restart mysql
```

### è°ƒè¯•æŠ€å·§

**1. APIæµ‹è¯•ï¼š**
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3001/health

# æµ‹è¯•æ”¶è—APIï¼ˆéœ€è¦tokenï¼‰
TOKEN="your_jwt_token"
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:3001/api/favorites/my

# æµ‹è¯•ç®¡ç†å‘˜API
ADMIN_TOKEN="admin_jwt_token"
curl -H "Authorization: Bearer $ADMIN_TOKEN" \
  http://localhost:3001/api/admin/products
```

**2. æ•°æ®åº“æŸ¥è¯¢ï¼š**
```bash
# æŸ¥çœ‹æ”¶è—æ•°æ®
docker exec ecommerce-mysql mysql -uroot -proot123456 ecommerce \
  -e "SELECT * FROM favorites LIMIT 10;"

# æŸ¥çœ‹SKUæ•°æ®
docker exec ecommerce-mysql mysql -uroot -proot123456 ecommerce \
  -e "SELECT * FROM product_skus WHERE product_id = 1;"
```

**3. Redisç¼“å­˜æ£€æŸ¥ï¼š**
```bash
# è¿›å…¥Redis
docker exec -it ecommerce-redis redis-cli

# æŸ¥çœ‹æ‰€æœ‰key
KEYS *

# æŸ¥çœ‹å•†å“ç¼“å­˜
GET product:1

# æ¸…é™¤ç¼“å­˜
FLUSHALL
```

---

## ğŸ“š å¾…å®ç°åŠŸèƒ½

### é«˜çº§åŠŸèƒ½
- [ ] Elasticsearch å…¨æ–‡æœç´¢é›†æˆ
- [ ] RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ
- [ ] è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆï¼ˆå»¶è¿Ÿé˜Ÿåˆ—ï¼‰
- [ ] é‚®ä»¶é€šçŸ¥ç³»ç»Ÿ

### æ€§èƒ½ä¼˜åŒ–
- [ ] æ•°æ®åº“è¯»å†™åˆ†ç¦»
- [ ] æŸ¥è¯¢ç»“æœç¼“å­˜
- [ ] APIå“åº”å‹ç¼©
- [ ] é™æµä¸­é—´ä»¶

### å®‰å…¨å¢å¼º
- [ ] APIè¯·æ±‚ç­¾åéªŒè¯
- [ ] SQLæ³¨å…¥é˜²æŠ¤å¢å¼º
- [ ] XSSé˜²æŠ¤
- [ ] CSRFé˜²æŠ¤

---

**æœ€åæ›´æ–°ï¼š** 2025å¹´10æœˆ29æ—¥  
**åç«¯çŠ¶æ€ï¼š** âœ… æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œ  
**APIæ•°é‡ï¼š** 50+ ä¸ªæ¥å£  
**ä»£ç è´¨é‡ï¼š** â­â­â­â­â­

